#!/usr/bin/env bash

#
# This file is part of Tornado: A heterogeneous programming framework: 
# https://github.com/beehive-lab/tornado
#
# Copyright (c) 2013-2019, APT Group, School of Computer Science,
# The University of Manchester. All rights reserved.
# DO NOT ALTER OR REMOVE COPYRIGHT NOTICES OR THIS FILE HEADER.
#
# This code is free software; you can redistribute it and/or modify it
# under the terms of the GNU General Public License version 2 only, as
# published by the Free Software Foundation.
#
# This code is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
# FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
# version 2 for more details (a copy is included in the LICENSE file that
# accompanied this code).
#
# You should have received a copy of the GNU General Public License version
# 2 along with this work; if not, write to the Free Software Foundation,
# Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301 USA.
#
# Authors: James Clarkson
#

MODULE_LIST=(
--add-modules ALL-SYSTEM
--add-exports jdk.internal.vm.ci/jdk.vm.ci.common=ALL-UNNAMED,jdk.internal.vm.compiler
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.hotspot.meta=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.replacements.classfile=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.alloc=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.util=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.cfg=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.framemap=ALL-UNNAMED
--add-exports jdk.internal.vm.ci/jdk.vm.ci.meta=ALL-UNNAMED,jdk.internal.vm.compiler
--add-exports jdk.internal.vm.ci/jdk.vm.ci.code=ALL-UNNAMED,jdk.internal.vm.compiler
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.graph=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.graph.spi=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.gen=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodeinfo=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.calc=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.spi=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/jdk.internal.vm.compiler.collections=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.api.runtime=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.code=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.target=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.debug=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.hotspot=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.java=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.asm=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.phases=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.graphbuilderconf=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.options=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.tiers=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.util=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.printer=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.runtime=ALL-UNNAMED
--add-exports jdk.internal.vm.ci/jdk.vm.ci.runtime=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.graph.iterators=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.java=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.bytecode=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.common=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.spi=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/jdk.internal.vm.compiler.word=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.api.replacements=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.replacements=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.common.inlining=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.phases=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.type=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.extended=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.loop=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.common.inlining.info=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.common.inlining.policy=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.common.inlining.walker=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.loop.phases=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.debug=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.memory=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.util=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.virtual=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.constopt=ALL-UNNAMED
--add-opens jdk.internal.vm.ci/jdk.vm.ci.hotspot=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.asm=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.cfg=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.phases.schedule=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.virtual.phases.ea=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.lir.ssa=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.common.calc=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.gen=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.core.match=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.memory.address=ALL-UNNAMED
--add-exports jdk.internal.vm.compiler/org.graalvm.compiler.nodes.type=ALL-UNNAMED
)

if [ -z "${TORNADO_SDK}" ]; then
    echo "Please ensure the TORNADO_SDK environment variable is set correctly"
    exit -1
fi

if [ -z "${JAVA_HOME}" ]; then
    echo "Please ensure the JAVA_HOME environment variable is set correctly"
fi

function print_usage {
    echo "usage:    tornado [options] class [arg0 ... argN]"
    echo ""
    echo "              -h|--help             This message"
    echo "              -v|--verbose          Enable verbose output"
    echo "              -d|--debug            Enable debug output"
    echo ""
    echo "              --printBytecodes      Print TornadoVM bytecodes"
    echo "              --igv                 Dump GRAAL IR into IGV"
    echo "              --printKernel         Print autogenerated OpenCL C Kernel"
    echo "              --debug               Print debugging information"
    echo "              --version             Print tornado version information"
    echo "              --printFlags          Prints Tornado Java flags and exits"
    echo "              --devices             Prints Tornado available devices and exits"
    echo ""
    exit 0
}

function print_version {
    cat "${TORNADO_SDK}/etc/tornado.release"
    exit 0
}

JARS=".:$PWD/"
for jar in ${TORNADO_SDK}/share/java/tornado/*
do
  JARS="$JARS:$jar"
done
JARS=(\"$JARS:\")

TORNADO_FLAGS="-classpath ${JARS[*]} -Djava.library.path=${TORNADO_SDK}/lib"
printflags=0
printdevices=0

POSITIONAL=()
while [[ $# -gt 0 ]]
do
key="$1"

case $key in
    --version)
    print_version
    shift
    ;;
    -v|--verbose)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dtornado.verbose=True"
    shift # past argument
    ;;
    -d|--debug)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dtornado.debug=True"
    shift # past argument
    ;;
    --igv)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dgraal.Dump=*:5 -Dgraal.PrintGraph=true -Dgraal.PrintCFG=false"
    shift # past argument
    ;;
    --printKernel)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dtornado.opencl.source.print=True "
    shift
	;;
    --printBytecodes)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dtornado.print.bytecodes=True "
    shift
    ;;
    --debug)
    TORNADO_FLAGS="${TORNADO_FLAGS} -Dtornado.debug=True "
    shift
    ;;
    --printFlags)
    printflags=1
    shift
    ;;
    --devices)
    printdevices=1
    shift
    ;;
    -h|--help)
    print_usage
    shift
    ;;
    *)    # unknown option
    POSITIONAL+=("$1") # save it in an array for later
    shift # past argument
    ;;
esac
done
set -- "${POSITIONAL[@]}" # restore positional parameters

JAVA_CMD=${JAVA_HOME}/bin/java
PROVIDERS=" \
-Dtornado.load.api.implementation=uk.ac.manchester.tornado.runtime.tasks.TornadoTaskSchedule \
-Dtornado.load.runtime.implementation=uk.ac.manchester.tornado.runtime.TornadoCoreRuntime \
-Dtornado.load.tornado.implementation=uk.ac.manchester.tornado.runtime.common.Tornado \
-Dtornado.load.device.implementation=uk.ac.manchester.tornado.drivers.opencl.runtime.TornadoDeviceFactory \
-Dtornado.load.annotation.implementation=uk.ac.manchester.tornado.annotation.ASMClassVisitor \
-Dtornado.load.annotation.parallel=uk.ac.manchester.tornado.api.annotations.Parallel "

#JAVA_FLAGS="-server -XX:-UseJVMCIClassLoader -XX:-UseCompressedOops ${TORNADO_FLAGS} ${PROVIDERS} "
#JAVA_FLAGS="-server -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseCompressedOops ${TORNADO_FLAGS} ${PROVIDERS} ${MODULE_LIST[*]} "
JAVA_FLAGS="-server -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI ${TORNADO_FLAGS} ${PROVIDERS} ${MODULE_LIST[*]} "
#JAVA_FLAGS="-server -XX:+UnlockExperimentalVMOptions -XX:+EnableJVMCI -XX:+UseJVMCICompiler -XX:+UseCompressedOops ${TORNADO_FLAGS} ${PROVIDERS} ${MODULE_LIST[*]} "

if [ $printflags -eq 1 ] ; then
	echo $JAVA_CMD
	echo $JAVA_FLAGS
	exit 0
fi

if [ $printdevices -eq 1 ] ; then
	tornado uk.ac.manchester.tornado.drivers.opencl.TornadoDeviceOutput verbose	
	exit 0
fi

#echo $JAVA_CMD
#echo $JAVA_FLAGS
#echo $@

${JAVA_CMD} ${JAVA_FLAGS} $@

